<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Summary - Chetan Catering</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --brand:#EA580C;
  --dark:#1E293B;
  --soft:#FFF7ED;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:linear-gradient(120deg,#FFF7ED,#FDFCF9,#F8FAFC);
  color:var(--dark);
  animation:fade .4s ease;
}

@keyframes fade{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:none}
}

.header{
  background:#fff;
  border-bottom:3px solid var(--brand);
  position:sticky;
  top:0;
  z-index:100;
  padding:12px 20px;
}
.header-inner{
  max-width:920px;
  margin:auto;
  display:grid;
  grid-template-columns:auto 1fr auto;
  align-items:center;
  gap:14px;
}
.logo-section{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo{
  display:flex;
  align-items:center;
  gap:10px;
}
.logo img{
  height:42px;
  width:42px;
  border-radius:8px;
  border:2px solid var(--brand);
  padding:2px;
  object-fit:contain;
}
.heading-title{
  font-size:18px;
  font-weight:800;
  color:var(--dark);
  white-space:nowrap;
  text-align:left;
}
.location-tag{
  font-size:13px;
  font-weight:600;
  color:#64748B;
  background:#F8FAFC;
  padding:8px 14px;
  border-radius:8px;
  white-space:nowrap;
}
.brand{
  font-weight:700;
  font-size:18px;
  color:var(--brand);
}
.brand span{
  color:#475569;
  font-weight:600;
}

.container{
  max-width:860px;
  margin:26px auto;
  padding:0 16px;
}

.page-title{
  text-align:center;
  margin-bottom:22px;
}
.page-title h1{
  font-size:26px;
  margin-bottom:6px;
}
.page-title p{
  color:#64748B;
  font-size:14px;
}

.card{
  background:var(--card);
  border-radius:20px;
  padding:26px;
  box-shadow:0 18px 40px rgba(0,0,0,.08);
}

.section{margin-bottom:28px}
.section-title{
  font-weight:700;
  margin-bottom:12px;
  padding-bottom:6px;
  border-bottom:2px solid var(--brand);
}

.row{
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin-bottom:8px;
  gap:10px;
}
.row span:first-child{
  color:#64748B;
}
.row span:last-child{
  font-weight:500;
  text-align:right;
}

.item{
  display:flex;
  justify-content:space-between;
  margin-bottom:8px;
  font-size:14px;
}

.total{
  font-size:17px;
  font-weight:700;
}

.payments{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.pay{
  flex:1;
  border:2px solid #E5E7EB;
  padding:12px;
  border-radius:12px;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  background:#fff;
}
.pay.active{
  border-color:var(--brand);
  background:#FFF7ED;
}

.actions{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}
.btn{
  padding:14px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
  transition:.3s;
}
.btn-primary{
  background:var(--brand);
  color:#fff;
}
.btn-secondary{
  background:#fff;
  border:2px solid var(--brand);
  color:var(--brand);
}
.btn:hover{
  transform:translateY(-2px);
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal.active{display:flex}
.modal-box{
  background:#fff;
  padding:32px;
  border-radius:22px;
  max-width:420px;
  width:90%;
  text-align:center;
}
.success{
  font-size:46px;
  color:#10B981;
  margin-bottom:10px;
}

.footer{
  margin-top:40px;
  padding:18px;
  text-align:center;
  font-size:13px;
  color:#64748B;
}

#pdfReceipt{
  display:none;
}

.message{
  text-align:center;
  padding:40px;
  color:#64748B;
}
.error-message{
  color:#EF4444;
}

.debug-box{
  margin-top:20px;
  padding:15px;
  background:#f0f0f0;
  border-radius:8px;
  font-size:12px;
  font-family:monospace;
  max-height:200px;
  overflow-y:auto;
  display:none;
}

@media(max-width:640px){
  .actions{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="header">
  <div class="header-inner">
    <div class="logo-section">
      <div class="logo">
        <img src="static/WhatsApp Image 2026-01-21 at 10.54.12 (1).jpeg" alt="Omsgr Catering Services">
      </div>
      <div class="heading-title">Omsgr Catering </div>
    </div>
    <div class="location-tag">üìç Siddakatte,KA</div>
  </div>
</div>

<div class="container">

<div class="page-title">
  <h1>Order Summary</h1>
  <p>Please review and confirm your booking details</p>
</div>

<div class="card">

<div class="section">
  <div class="section-title">Event Details</div>
  <div class="row"><span>Date</span><span id="date">-</span></div>
  <div class="row"><span>Time</span><span id="time">-</span></div>
  <div class="row"><span>Guests</span><span id="guests">-</span></div>
  <div class="row"><span>Food Type</span><span id="food">-</span></div>
  <div class="row"><span>Service Type</span><span id="serviceType">-</span></div>
</div>

<div class="section">
  <div class="section-title">Customer Details</div>
  <div class="row"><span>Name</span><span id="name">-</span></div>
  <div class="row"><span>Mobile</span><span id="mobile">-</span></div>
  <div class="row"><span>Email</span><span id="email">-</span></div>
  <div class="row"><span>Location</span><span id="address" style="white-space:pre-line">-</span></div>
</div>

<div class="section">
  <div class="section-title">Selected Dishes</div>
  <div id="items">
    <div class="message">Loading dishes...</div>
  </div>
</div>

<div class="section">
  <div class="section-title">Price Summary</div>
  <div class="row"><span>Subtotal</span><span>‚Çπ<span id="sub">0</span></span></div>
  <div class="row"><span>Service (10%)</span><span>‚Çπ<span id="ser">0</span></span></div>
  <div class="row"><span>GST (5%)</span><span>‚Çπ<span id="gst">0</span></span></div>
  <div class="row total"><span>Total Amount</span><span>‚Çπ<span id="tot">0</span></span></div>
</div>

<div class="section">
  <div class="section-title">Payment Option</div>
  <div class="payments">
    <div class="pay active" onclick="paySelect('Advance',this)">Advance</div>
    <div class="pay" onclick="paySelect('Full Payment',this)">Full Payment</div>
    <div class="pay" onclick="paySelect('Cash on Service',this)">Cash on Service</div>
  </div>
</div>

<div class="actions">
  <button class="btn btn-secondary" onclick="location.href='/booking'">‚Üê Back</button>
  <button class="btn btn-primary" id="confirmBtn" onclick="submitBooking()">Confirm Booking</button>
</div>

</div>

<!-- DEBUG BOX (Remove in production) -->
<div class="debug-box" id="debugBox"></div>

</div>

<div class="footer">
  ¬© 2026 Chetan Catering Services ¬∑ Professional Catering Solutions
</div>

<div class="modal" id="done">
  <div class="modal-box">
    <div class="success">‚úì</div>
    <h2>Booking Submitted</h2>
    <p>
      Your booking is sent to <b>Chetan Catering</b>.<br>
      Ingredients list will be shared within <b>24 hours</b>.
    </p>

    <!-- Rating Section -->
    <div id="ratingSection" style="margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;display:none;">
      <h3 style="margin-bottom:12px;color:#EA580C;">Rate Your Experience</h3>
      <p style="font-size:14px;color:#64748B;margin-bottom:15px;">Help us improve by rating your booking experience</p>

      <div style="display:flex;gap:8px;margin-bottom:15px;justify-content:center;">
        <button class="star-btn" data-rating="1">‚òÜ</button>
        <button class="star-btn" data-rating="2">‚òÜ</button>
        <button class="star-btn" data-rating="3">‚òÜ</button>
        <button class="star-btn" data-rating="4">‚òÜ</button>
        <button class="star-btn" data-rating="5">‚òÜ</button>
      </div>

      <button id="submitRatingBtn" class="btn btn-primary" style="width:100%;display:none;" onclick="submitRating()">Submit Rating</button>
      <div id="ratingMessage" style="margin-top:10px;font-size:14px;text-align:center;"></div>
    </div>

    <div style="display:grid;gap:12px;margin-top:18px">
      <button class="btn btn-secondary" onclick="downloadReceipt()">Download Receipt</button>
      <button class="btn btn-primary" onclick="goHome()">Go Home</button>
    </div>
  </div>
</div>

<div id="pdfReceipt" style="display:none;">
  <div style="
    max-width:700px;
    margin:auto;
    border-radius:20px;
    padding:28px;
    box-shadow:0 18px 40px rgba(0,0,0,.08);
    background:linear-gradient(120deg,#FFF7ED,#FDFCF9,#F8FAFC);
    font-family:Inter,sans-serif;
    color:#1E293B;
  ">
    <div style="text-align:center; margin-bottom:20px;">
      <h2 style="margin:0; color:#EA580C;">Chetan Catering Services</h2>
      <p style="margin:4px 0; font-size:14px;">Order Summary</p>
    </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin-bottom:8px; border-bottom:2px solid #EA580C; padding-bottom:4px;">Event Details</h3>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Date:</span><span id="pdfDate"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Time:</span><span id="pdfTime"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Guests:</span><span id="pdfGuests"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Food Type:</span><span id="pdfFood"></span></div>
    </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin-bottom:8px; border-bottom:2px solid #EA580C; padding-bottom:4px;">Customer Details</h3>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Name:</span><span id="pdfName"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Mobile:</span><span id="pdfMobile"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Email:</span><span id="pdfEmail"></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Address:</span><span id="pdfAddress"></span></div>
    </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin-bottom:8px; border-bottom:2px solid #EA580C; padding-bottom:4px;">Selected Dishes</h3>
      <div id="pdfItems"></div>
    </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin-bottom:8px; border-bottom:2px solid #EA580C; padding-bottom:4px;">Price Summary</h3>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Subtotal:</span><span>‚Çπ<span id="pdfSub"></span></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>Service (10%):</span><span>‚Çπ<span id="pdfService"></span></span></div>
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span>GST (5%):</span><span>‚Çπ<span id="pdfGST"></span></span></div>
      <div style="display:flex;justify-content:space-between;font-weight:700;font-size:16px;"><span>Total:</span><span>‚Çπ<span id="pdfTotal"></span></span></div>
    </div>

    <div style="margin-bottom:20px;">
      <h3 style="margin-bottom:8px; border-bottom:2px solid #EA580C; padding-bottom:4px;">Payment Option</h3>
      <p id="pdfPayment"></p>
    </div>

    <div style="text-align:center; font-size:12px; color:#64748B; margin-top:10px;">
      ¬© 2026 Chetan Catering Services ¬∑ Thank you for your booking
    </div>
  </div>
</div>

<script>
// ============================================
// IMPROVED ORDER SUMMARY WITH OPTIMISTIC UI
// ============================================

let payment = "Advance";
let isSubmitting = false; // Prevent double submission

// Get element references
const dateEl = document.getElementById("date");
const timeEl = document.getElementById("time");
const guestsEl = document.getElementById("guests");
const foodEl = document.getElementById("food");
const serviceTypeEl = document.getElementById("serviceType");
const nameEl = document.getElementById("name");
const mobileEl = document.getElementById("mobile");
const emailEl = document.getElementById("email");
const addressEl = document.getElementById("address");
const itemsEl = document.getElementById("items");
const subEl = document.getElementById("sub");
const serEl = document.getElementById("ser");
const gstEl = document.getElementById("gst");
const totEl = document.getElementById("tot");

// ============================================
// SANITIZATION FUNCTIONS
// ============================================

function sanitizeHTML(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function validateEmail(email) {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

function validateMobile(mobile) {
  // Remove spaces and special characters
  const cleaned = mobile.replace(/[\s\-\(\)]/g, '');
  // Check if it's a valid Indian mobile (10 digits or +91 followed by 10 digits)
  return /^(\+91)?[6-9]\d{9}$/.test(cleaned);
}

function sanitizeBookingData(data) {
  return {
    customer_name: sanitizeHTML(data.customerName || ""),
    mobile: data.mobile ? data.mobile.trim() : "",
    email: data.email ? data.email.trim().toLowerCase() : "",
    event_location: sanitizeHTML(data.eventLocation || data.address || ""),
    map_link: sanitizeHTML(data.mapLink || ""),
    service_type: sanitizeHTML(data.serviceType || "Catering Service"),
    event_date: data.eventDate || "",
    time_slot: data.timeSlot || "",
    guests: parseInt(data.guests) || 0,
    food_preference: sanitizeHTML(data.foodPreference || "")
  };
}

// ============================================
// PAYMENT SELECTION
// ============================================

function paySelect(p, el) {
  payment = p;
  document.querySelectorAll(".pay").forEach(x => x.classList.remove("active"));
  el.classList.add("active");
}

// ============================================
// LOAD ORDER DATA (OPTIMIZED)
// ============================================

function load() {
  console.log("=== LOADING ORDER SUMMARY ===");
  
  try {
    // Get data from sessionStorage
    const bookingDataStr = sessionStorage.getItem("bookingData");
    const cartStr = sessionStorage.getItem("cart");
    
    if (!bookingDataStr || !cartStr) {
      showError("No booking data found. Please complete the booking form.");
      return;
    }

    const b = JSON.parse(bookingDataStr);
    const c = JSON.parse(cartStr);

    // Validate data exists
    if (Object.keys(b).length === 0) {
      showError("Invalid booking data. Please go back and fill the form.");
      return;
    }

    if (Object.keys(c).length === 0) {
      showError("No dishes selected. Please go back and select dishes.");
      return;
    }

    // Sanitize and display data
    displayEventDetails(b);
    displayCustomerDetails(b);
    const subtotal = displayDishes(c);
    
    if (subtotal === 0) {
      showError("No dishes with quantity selected.");
      return;
    }

    displayPricing(subtotal);
    
    console.log("=== ORDER SUMMARY LOADED SUCCESSFULLY ===");
  } catch (error) {
    console.error("Error loading order summary:", error);
    showError("Failed to load order summary. Please try again.");
  }
}

// ============================================
// DISPLAY FUNCTIONS
// ============================================

function displayEventDetails(b) {
  dateEl.textContent = sanitizeHTML(b.eventDate || "N/A");
  timeEl.textContent = sanitizeHTML(b.timeSlot || "N/A");
  guestsEl.textContent = sanitizeHTML(String(b.guests || "N/A"));
  foodEl.textContent = sanitizeHTML(b.foodPreference || "N/A");
  serviceTypeEl.textContent = sanitizeHTML(b.serviceType || "Catering Service");
}

function displayCustomerDetails(b) {
  nameEl.textContent = sanitizeHTML(b.customerName || "N/A");
  
  // Format mobile number safely
  let mobileDisplay = b.mobile || "N/A";
  if (mobileDisplay !== "N/A") {
    mobileDisplay = mobileDisplay.trim();
    if (!mobileDisplay.startsWith("+91")) {
      mobileDisplay = "+91 " + mobileDisplay;
    } else if (!mobileDisplay.includes(" ")) {
      mobileDisplay = mobileDisplay.replace("+91", "+91 ");
    }
  }
  mobileEl.textContent = sanitizeHTML(mobileDisplay);
  
  emailEl.textContent = sanitizeHTML(b.email || "N/A");
  
  // Build address display
  let addressDisplay = buildAddress(b);
  addressEl.textContent = sanitizeHTML(addressDisplay);
}

function buildAddress(b) {
  if (b.village || b.taluk || b.district) {
    let locationParts = [];
    if (b.village) locationParts.push(b.village);
    if (b.taluk) locationParts.push(b.taluk);
    if (b.district) locationParts.push(b.district);
    let addressDisplay = locationParts.join(", ");
    
    if (b.address) {
      addressDisplay += "\n" + b.address;
    }
    return addressDisplay;
  } else if (b.eventLocation) {
    return b.eventLocation;
  } else if (b.address) {
    return b.address;
  }
  return "N/A";
}

function displayDishes(c) {
  let subtotal = 0;
  let html = "";

  Object.keys(c).forEach(dishId => {
    const cartItem = c[dishId];
    
    let quantity, dishName, dishPrice;
    
    if (typeof cartItem === 'object') {
      quantity = cartItem.quantity;
      dishName = cartItem.name;
      dishPrice = cartItem.price;
    } else {
      quantity = cartItem;
      dishName = "Unknown Dish";
      dishPrice = 0;
    }

    if (quantity > 0) {
      const totalPrice = dishPrice * quantity;
      subtotal += totalPrice;
      html += `<div class="item"><span>${sanitizeHTML(dishName)} √ó ${quantity}</span><span>‚Çπ${totalPrice}</span></div>`;
    }
  });

  itemsEl.innerHTML = html || '<div class="message error-message">No dishes selected.</div>';
  return subtotal;
}

function displayPricing(subtotal) {
  const service = Math.round(subtotal * 0.1);
  const gst = Math.round((subtotal + service) * 0.05);
  const total = subtotal + service + gst;

  subEl.textContent = subtotal;
  serEl.textContent = service;
  gstEl.textContent = gst;
  totEl.textContent = total;
}

function showError(message) {
  itemsEl.innerHTML = `<div class="message error-message">${sanitizeHTML(message)}</div>`;
}

// ============================================
// OPTIMISTIC UI SUBMISSION
// ============================================

async function submitBooking() {
  // Prevent double submission
  if (isSubmitting) {
    return;
  }

  const confirmBtn = document.getElementById("confirmBtn");
  
  try {
    // Get data
    const bookingDataStr = sessionStorage.getItem("bookingData");
    const cartStr = sessionStorage.getItem("cart");

    if (!bookingDataStr || !cartStr) {
      alert("Missing booking data. Please complete the booking flow.");
      return;
    }

    const b = JSON.parse(bookingDataStr);
    const c = JSON.parse(cartStr);

    // Validate data
    if (!validateBookingData(b)) {
      return;
    }

    // Build dishes array
    const selectedDishes = buildDishesArray(c);
    
    if (selectedDishes.length === 0) {
      alert("No dishes selected!");
      return;
    }

    // Set submitting state
    isSubmitting = true;
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<span style="opacity:0.7">‚è≥ Submitting...</span>';

    // Prepare sanitized booking data
    const sanitizedData = sanitizeBookingData(b);
    const bookingData = {
      ...sanitizedData,
      selected_dishes: selectedDishes
    };

    // OPTIMISTIC UI: Show success immediately
    setTimeout(() => {
      preparePDFReceipt();
      document.getElementById("done").classList.add("active");
    }, 300); // Small delay for better UX

    // Send request in background
    const response = await fetch('/api/bookings/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(bookingData)
    });

    const result = await response.json();

    if (!response.ok || !result.success) {
      // If failed, hide success modal and show error
      document.getElementById("done").classList.remove("active");
      alert('Booking failed: ' + (result.error || result.message || 'Unknown error'));
      
      // Reset button
      isSubmitting = false;
      confirmBtn.disabled = false;
      confirmBtn.textContent = "Confirm Booking";
    }
    // If successful, modal is already shown (optimistic UI)

  } catch (error) {
    console.error('Error submitting booking:', error);
    
    // Hide success modal if shown
    document.getElementById("done").classList.remove("active");
    alert('Network error. Please check your connection and try again.');
    
    // Reset button
    isSubmitting = false;
    confirmBtn.disabled = false;
    confirmBtn.textContent = "Confirm Booking";
  }
}

// ============================================
// VALIDATION FUNCTIONS
// ============================================

function validateBookingData(b) {
  if (!b.customerName || b.customerName.trim().length < 2) {
    alert("Please enter a valid customer name.");
    return false;
  }

  if (!validateMobile(b.mobile)) {
    alert("Please enter a valid mobile number.");
    return false;
  }

  if (!validateEmail(b.email)) {
    alert("Please enter a valid email address.");
    return false;
  }

  if (!b.eventDate || !b.timeSlot) {
    alert("Please select event date and time slot.");
    return false;
  }

  if (!b.guests || b.guests < 1) {
    alert("Please specify number of guests.");
    return false;
  }

  return true;
}

function buildDishesArray(cart) {
  const dishes = [];
  Object.keys(cart).forEach(dishId => {
    const cartItem = cart[dishId];
    const quantity = typeof cartItem === 'object' ? cartItem.quantity : cartItem;

    if (quantity > 0) {
      dishes.push({
        dish_id: String(dishId),
        quantity: parseInt(quantity)
      });
    }
  });
  return dishes;
}

// ============================================
// PDF RECEIPT PREPARATION
// ============================================

function preparePDFReceipt() {
  document.getElementById("pdfDate").textContent = dateEl.textContent;
  document.getElementById("pdfTime").textContent = timeEl.textContent;
  document.getElementById("pdfGuests").textContent = guestsEl.textContent;
  document.getElementById("pdfFood").textContent = foodEl.textContent;
  document.getElementById("pdfName").textContent = nameEl.textContent;
  document.getElementById("pdfMobile").textContent = mobileEl.textContent;
  document.getElementById("pdfEmail").textContent = emailEl.textContent;
  document.getElementById("pdfAddress").textContent = addressEl.textContent;
  document.getElementById("pdfItems").innerHTML = itemsEl.innerHTML;
  document.getElementById("pdfSub").textContent = subEl.textContent;
  document.getElementById("pdfService").textContent = serEl.textContent;
  document.getElementById("pdfGST").textContent = gstEl.textContent;
  document.getElementById("pdfTotal").textContent = totEl.textContent;
  document.getElementById("pdfPayment").textContent = payment;
}

function generatePDF() {
  const el = document.getElementById("pdfReceipt");
  el.style.display = "block";

  html2pdf().from(el).set({
    margin: 10,
    filename: `Chetan-Catering-Order-${Date.now()}.pdf`,
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  }).save().then(() => {
    el.style.display = "none";
  }).catch(err => {
    console.error("PDF generation failed:", err);
    alert("Failed to generate PDF. Please try again.");
    el.style.display = "none";
  });
}

function downloadReceipt() {
  generatePDF();
}

function goHome() {
  sessionStorage.clear();
  location.href = "/";
}

// ============================================
// INITIALIZE ON PAGE LOAD
// ============================================

window.addEventListener('DOMContentLoaded', function() {
  console.log("Page loaded, initializing...");
  load();
});

// Prevent accidental page refresh
window.addEventListener('beforeunload', function(e) {
  if (isSubmitting) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// ============================================
// RATING SYSTEM
// ============================================

let selectedRating = 0;
let bookingId = null; // Will be set when booking is successful

// Initialize rating system when success modal is shown
function initRatingSystem() {
  // Get booking ID from session or generate one (simplified for demo)
  // In a real app, this would come from the booking response
  const bookingDataStr = sessionStorage.getItem("bookingData");
  if (bookingDataStr) {
    const bookingData = JSON.parse(bookingDataStr);
    // For demo purposes, we'll use a placeholder. In real implementation,
    // the booking ID would be returned from the successful booking API call
    bookingId = "demo_booking_id_" + Date.now();
  }

  // Show rating section after a short delay
  setTimeout(() => {
    document.getElementById("ratingSection").style.display = "block";
  }, 2000); // Show after 2 seconds

  // Add event listeners to star buttons
  document.querySelectorAll('.star-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      selectedRating = parseInt(this.dataset.rating);
      updateStarDisplay(selectedRating);
      document.getElementById("submitRatingBtn").style.display = "block";
      document.getElementById("ratingMessage").textContent = "";
    });
  });
}

function updateStarDisplay(rating) {
  document.querySelectorAll('.star-btn').forEach((btn, index) => {
    if (index < rating) {
      btn.classList.add('selected');
      btn.textContent = '‚òÖ'; // Filled star
    } else {
      btn.classList.remove('selected');
      btn.textContent = '‚òÜ'; // Empty star
    }
  });
}

async function submitRating() {
  if (!selectedRating || !bookingId) {
    document.getElementById("ratingMessage").textContent = "Please select a rating first.";
    document.getElementById("ratingMessage").style.color = "#EF4444";
    return;
  }

  const submitBtn = document.getElementById("submitRatingBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = "Submitting...";

  try {
    const response = await fetch(`/admin/api/rate-booking/${bookingId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ rating: selectedRating })
    });

    const result = await response.json();

    if (response.ok && result.success) {
      document.getElementById("ratingMessage").textContent = "Thank you for your feedback!";
      document.getElementById("ratingMessage").style.color = "#10B981";
      submitBtn.style.display = "none";

      // Hide rating section after successful submission
      setTimeout(() => {
        document.getElementById("ratingSection").style.display = "none";
      }, 2000);
    } else {
      document.getElementById("ratingMessage").textContent = result.error || "Failed to submit rating.";
      document.getElementById("ratingMessage").style.color = "#EF4444";
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Rating";
    }
  } catch (error) {
    console.error('Error submitting rating:', error);
    document.getElementById("ratingMessage").textContent = "Network error. Please try again.";
    document.getElementById("ratingMessage").style.color = "#EF4444";
    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Rating";
  }
}

// Initialize rating when success modal becomes visible
const observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
      const modal = document.getElementById('done');
      if (modal.classList.contains('active')) {
        initRatingSystem();
      }
    }
  });
});

observer.observe(document.getElementById('done'), {
  attributes: true,
  attributeFilter: ['class']
});
</script>

</body>
</html>