<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Chetan Catering Services</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css" crossorigin="anonymous">

    <style>
        :root {
            --primary: #EA580C;
            --primary-light: #FFEDD5;
            --primary-dark: #C2410C;
            --secondary: #0F172A;
            --bg-body: #F1F5F9;
            --white: #FFFFFF;
            --text-main: #1E293B;
            --text-muted: #64748B;
            --border: #E2E8F0;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --sidebar-width: 280px;
            --sidebar-collapsed: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            display: flex; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Sidebar --- */
        aside {
            width: var(--sidebar-width);
            background: var(--secondary);
            color: white;
            padding: 24px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            transition: all 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        aside.collapsed {
            width: var(--sidebar-collapsed);
            padding: 20px 10px;
        }

        .logo-area { 
            font-size: 22px; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 40px; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            white-space: nowrap;
        }
        
        .logo-area i {
            font-size: 28px;
        }

        aside.collapsed .logo-area span {
            display: none;
        }
        
        .nav-menu { list-style: none; flex-grow: 1; }
        .nav-item { 
            padding: 14px 16px; 
            border-radius: 10px; 
            margin-bottom: 8px; 
            cursor: pointer; 
            transition: all 0.3s; 
            display: flex; 
            align-items: center; 
            gap: 12px;
            color: #94A3B8;
            font-weight: 500;
            font-size: 15px;
        }

        .nav-item i {
            font-size: 18px;
            min-width: 20px;
        }

        .nav-item:hover { 
            background: rgba(234, 88, 12, 0.15); 
            color: var(--primary); 
            transform: translateX(5px);
        }
        
        .nav-item.active { 
            background: var(--primary); 
            color: white;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }

        aside.collapsed .nav-item span {
            display: none;
        }

        aside.collapsed .nav-item {
            justify-content: center;
            padding: 14px 8px;
        }

        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- Main Content --- */
        main { 
            margin-left: var(--sidebar-width); 
            flex-grow: 1; 
            padding: 32px 40px;
            width: calc(100% - var(--sidebar-width));
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        main.expanded {
            margin-left: var(--sidebar-collapsed);
            width: calc(100% - var(--sidebar-collapsed));
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .header-top h1 { 
            font-size: 32px; 
            font-weight: 700;
            color: var(--secondary);
        }

        .header-top #currentDate {
            color: var(--text-muted);
            font-weight: 500;
            font-size: 15px;
        }

        /* --- Stats Grid --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 24px; 
            margin-bottom: 32px;
        }
        
        .stat-card { 
            background: var(--white); 
            padding: 28px; 
            border-radius: 16px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }
        
        .stat-label { 
            color: var(--text-muted); 
            font-size: 14px; 
            font-weight: 600; 
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value { 
            font-size: 32px; 
            font-weight: 700; 
            color: var(--secondary);
        }

        /* --- Cards & Components --- */
        .card { 
            background: var(--white); 
            border-radius: 16px; 
            padding: 28px; 
            margin-bottom: 24px; 
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .card-header { 
            margin-bottom: 24px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .card-title { 
            font-size: 22px; 
            font-weight: 700;
            color: var(--secondary);
        }

        /* --- Forms --- */
        .form-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px;
        }
        
        .form-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
        }
        
        .full-width { grid-column: 1 / -1; }
        
        input, select, textarea { 
            padding: 12px 16px; 
            border-radius: 10px; 
            border: 1px solid var(--border); 
            font-family: inherit;
            font-size: 15px;
            outline: none;
            transition: all 0.2s;
            background: var(--white);
        }
        
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); 
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .btn { 
            padding: 12px 24px; 
            border-radius: 10px; 
            font-weight: 600; 
            font-size: 15px;
            cursor: pointer; 
            border: none; 
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
        }
        
        .btn-primary:hover { 
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(234, 88, 12, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: #3B82F6;
            color: white;
        }

        /* --- Dishes Grid --- */
        .dishes-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 24px;
        }
        
        .dish-card { 
            background: var(--white); 
            border-radius: 14px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .dish-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 12px 24px rgba(0,0,0,0.12);
        }
        
        .dish-img { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            background: #eee;
        }
        
        .dish-info { padding: 20px; }
        
        .dish-cat { 
            font-size: 12px; 
            font-weight: 700; 
            color: var(--primary); 
            text-transform: uppercase; 
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .dish-info h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-main);
        }
        
        .dish-price { 
            font-size: 20px; 
            font-weight: 700; 
            color: var(--primary);
        }

        /* --- Tabs --- */
        .tab-content { display: none; }
        .tab-content.active { 
            display: block; 
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* --- Tables --- */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            background: white;
        }
        
        .orders-table th, .orders-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }
        
        .orders-table th {
            background: var(--bg-body);
            font-weight: 600;
            color: var(--text-main);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .orders-table tr:hover { background: var(--bg-body); }
        
        .order-id { font-weight: 600; color: var(--primary); }
        .order-amount { font-weight: 700; color: var(--primary); font-size: 16px; }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }
        
        .status-pending { background: #fef3c7; color: #f59e0b; }
        .status-approved { background: #dbeafe; color: #3b82f6; }
        .status-completed { background: #d1fae5; color: #10b981; }
        .status-cancelled { background: #fee2e2; color: #ef4444; }
        
        .action-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            border: none;
            margin-right: 6px;
            margin-bottom: 6px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .action-btn:hover { 
            opacity: 0.8;
            transform: translateY(-2px);
        }
        
        .action-view { background: var(--primary); color: white; }
        .action-ingredients { background: var(--warning); color: white; }
        .action-pdf { background: var(--success); color: white; }

        /* Orders Grouping */
        .date-group {
            margin-bottom: 28px;
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            background: var(--white);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .date-header {
            background: var(--primary);
            color: white;
            padding: 18px 24px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }
        
        .date-header:hover { background: var(--primary-dark); }
        .date-header i { transition: 0.3s; }
        .date-header.collapsed i { transform: rotate(-90deg); }
        
        .time-slot-group {
            margin: 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .time-header {
            background: var(--bg-body);
            padding: 14px 20px;
            font-weight: 600;
            font-size: 15px;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }
        
        .time-header:hover { background: #e2e8f0; }
        .time-header i { transition: 0.3s; }
        .time-header.collapsed i { transform: rotate(-90deg); }

        .group-content { display: block; }
        .group-content.collapsed { display: none; }

        .date-group.fully-booked .date-header {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border-left: 4px solid #b91c1c;
        }

        .time-slot-group.slot-booked .time-header {
            background: linear-gradient(135deg, #f87171, #ef4444);
            color: white;
            border-left: 3px solid #dc2626;
        }

        /* Availability Calendar */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .date-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .date-card:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,.12);
            transform: translateY(-4px);
        }

        .date-card.available {
            border-color: var(--success);
            background: #ECFDF5;
        }

        .date-card.partially {
            border-color: var(--warning);
            background: #FEF3C7;
        }

        .date-card.fully-booked {
            border-color: var(--danger);
            background: #FEE2E2;
        }

        .date-header {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .date-day {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 14px;
            font-weight: 500;
        }

        .slots {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .slot {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
        }

        .slot.available {
            background: #D1FAE5;
            color: #065F46;
        }

        .slot.booked {
            background: #FEE2E2;
            color: #991B1B;
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: 2px solid var(--border);
            background: var(--white);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .legend {
            display: flex;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .legend-color {
            width: 28px;
            height: 28px;
            border-radius: 6px;
        }

        .loading, .error-message { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-muted);
            font-size: 15px;
        }
        
        .error-message { 
            color: var(--danger); 
            background: #FEE2E2; 
            border-radius: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            font-style: italic;
            font-size: 16px;
        }

        .alert {
            background: #fef3c7;
            color: #92400e;
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            border: 1px solid #f59e0b;
            font-size: 14px;
        }

        /* Ingredient Rows */
        .ingredient-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-body);
            flex-wrap: wrap;
        }

        .ingredient-row input,
        .ingredient-row select {
            flex: 1;
            min-width: 120px;
        }

        /* --- Responsive Design --- */
        @media(max-width: 1024px) {
            aside {
                width: var(--sidebar-collapsed);
                padding: 20px 10px;
            }

            aside .logo-area span,
            aside .nav-item span {
                display: none;
            }

            aside .nav-item {
                justify-content: center;
                padding: 14px 8px;
            }

            main {
                margin-left: var(--sidebar-collapsed);
                width: calc(100% - var(--sidebar-collapsed));
                padding: 24px 20px;
            }

            .header-top h1 {
                font-size: 26px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-value {
                font-size: 26px;
            }

            .dishes-grid {
                grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
                gap: 16px;
            }

            .calendar-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        @media(max-width: 768px) {
            .sidebar-toggle {
                display: block;
            }

            aside {
                transform: translateX(-100%);
                width: 280px;
                padding: 24px;
            }

            aside.mobile-open {
                transform: translateX(0);
            }

            aside.mobile-open .logo-area span,
            aside.mobile-open .nav-item span {
                display: inline;
            }

            aside.mobile-open .nav-item {
                justify-content: flex-start;
                padding: 14px 16px;
            }

            main {
                margin-left: 0;
                width: 100%;
                padding: 80px 16px 20px;
            }

            main.expanded {
                margin-left: 0;
                width: 100%;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-top h1 {
                font-size: 24px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .stat-card {
                padding: 18px;
            }

            .stat-value {
                font-size: 24px;
            }

            .card {
                padding: 20px;
            }

            .card-title {
                font-size: 18px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .dishes-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .orders-table {
                font-size: 12px;
            }

            .orders-table th,
            .orders-table td {
                padding: 10px 8px;
            }

            .action-btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .date-header,
            .time-header {
                padding: 12px 16px;
                font-size: 14px;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }

            .filter-bar {
                gap: 8px;
            }

            .filter-btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .btn {
                padding: 10px 18px;
                font-size: 14px;
            }

            .ingredient-row {
                flex-direction: column;
                align-items: stretch;
            }

            .ingredient-row input,
            .ingredient-row select,
            .ingredient-row button {
                width: 100%;
            }
        }

        @media(max-width: 480px) {
            .header-top h1 {
                font-size: 20px;
            }

            .stat-value {
                font-size: 22px;
            }

            .stat-label {
                font-size: 12px;
            }

            .card-title {
                font-size: 16px;
            }

            input, select, textarea {
                font-size: 14px;
                padding: 10px 14px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .legend {
                gap: 16px;
            }

            .legend-item {
                font-size: 13px;
            }
        }

        /* Table Scroll for Mobile */
        @media(max-width: 768px) {
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .orders-table {
                min-width: 700px;
            }
        }
    </style>
</head>
<body>

<button class="sidebar-toggle" onclick="toggleMobileSidebar()">
    <i class="fas fa-bars"></i>
</button>

<aside id="sidebar">
    <div class="logo-area">
        <i class="fas fa-utensils"></i>
        <span>Chetan Catering</span>
    </div>
    <ul class="nav-menu">
        <li class="nav-item tab active" onclick="switchTab('dishes', this)">
            <i class="fas fa-hamburger"></i> <span>Manage Dishes</span>
        </li>
        <li class="nav-item tab" onclick="switchTab('orders', this)">
            <i class="fas fa-shopping-bag"></i> <span>View Orders</span>
        </li>
        <li class="nav-item tab" onclick="switchTab('ingredients', this)">
            <i class="fas fa-list-check"></i> <span>Ingredients</span>
        </li>
        <li class="nav-item tab" onclick="switchTab('finalization', this)">
            <i class="fas fa-clipboard-check"></i> <span>Finalization</span>
        </li>
        <li class="nav-item tab" onclick="switchTab('availability', this)">
            <i class="fas fa-calendar-alt"></i> <span>Availability</span>
        </li>
    </ul>
    <div class="nav-item" onclick="logout()" style="margin-top: auto; color: #f87171;">
        <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
    </div>
</aside>

<main id="mainContent">
    <div class="header-top">
        <h1>Dashboard Overview</h1>
        <div id="currentDate"></div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value" id="statOrders">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Active Dishes</div>
            <div class="stat-value" id="statDishes">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" id="statRevenue">â‚¹0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Pending Bookings</div>
            <div class="stat-value" id="statPending" style="color: var(--warning);">0</div>
        </div>
    </div>

    <div id="dishes" class="tab-content active">
        <div class="card">
            <div class="card-header"><h2 class="card-title">Add New Menu Item</h2></div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Dish Name</label>
                    <input id="dishName" placeholder="e.g. Paneer Butter Masala">
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="dishCategory"></select>
                </div>
                <div class="form-group">
                    <label>Price (â‚¹)</label>
                    <input id="dishPrice" type="number" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input id="dishImageUrl" placeholder="https://...">
                </div>
                <div class="form-group full-width">
                    <label>Description</label>
                    <textarea id="dishDescription" rows="2" placeholder="Brief description of the dish..."></textarea>
                </div>
            </div>

            <div class="card" style="margin-top: 24px; border: 2px solid var(--primary-light);">
                <div class="card-header" style="background: var(--primary-light); margin: -28px -28px 20px; padding: 20px 28px; border-radius: 16px 16px 0 0;">
                    <h3 class="card-title" style="color: var(--primary); margin: 0;">Dish Ingredients (Base quantities for 10 persons)</h3>
                </div>
                <div id="ingredientsContainer"></div>
                <div style="padding-top: 16px; border-top: 1px solid var(--border); margin-top: 16px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="addIngredientRow()">
                        <i class="fas fa-plus"></i> Add Ingredient
                    </button>
                    <button class="btn" style="background: var(--danger); color: white;" onclick="clearAllIngredients()">
                        <i class="fas fa-trash"></i> Clear All
                    </button>
                </div>
            </div>

            <div style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 15px;">
                    <input type="checkbox" id="dishAvailable" checked style="width: 18px; height: 18px;"> Available for order
                </label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <input id="newCategory" placeholder="New Category" style="min-width: 150px;">
                    <button class="btn btn-primary" onclick="addCategory()">Add Category</button>
                    <button class="btn btn-primary" onclick="addDish()"><i class="fas fa-plus"></i> Add to Menu</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Menu Gallery</h2>
                <div class="filters" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <input id="filterSearch" placeholder="Search..." onkeyup="filterDishes()" style="padding: 10px 14px; min-width: 200px;">
                    <select id="filterCategory" onchange="filterDishes()" style="padding: 10px 14px; min-width: 150px;"><option value="">All</option></select>
                </div>
            </div>
            <div class="dishes-grid" id="dishesGrid"></div>
        </div>
    </div>

    <div id="orders" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Order Management</h2>
                <div class="filters" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">From Date</label>
                        <input type="date" id="filterFromDate" onchange="applyFilters()" style="padding: 10px 14px;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">To Date</label>
                        <input type="date" id="filterToDate" onchange="applyFilters()" style="padding: 10px 14px;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Time Slot</label>
                        <select id="filterTimeSlot" onchange="applyFilters()" style="padding: 10px 14px;">
                            <option value="">All Time Slots</option>
                            <option value="Morning">Morning</option>
                            <option value="Afternoon">Afternoon</option>
                            <option value="Evening">Evening</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Status</label>
                        <select id="filterStatus" onchange="applyFilters()" style="padding: 10px 14px;">
                            <option value="">All Status</option>
                            <option value="Pending">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="Completed">Completed</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="clearFilters()" style="padding: 10px 18px;">Clear Filters</button>
                </div>
            </div>
            <div id="ordersLoading" class="loading" style="display: none;">Loading orders...</div>
            <div id="ordersError" class="error-message" style="display: none;"></div>
            <div class="table-wrapper">
                <table class="orders-table" id="ordersTable">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Customer</th>
                            <th>Event Date</th>
                            <th>Guests</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="ingredients" class="tab-content">
        <div class="card">
            <div class="card-header"><h2 class="card-title">Ingredient Planning Tool</h2></div>
            <div class="alert">
                <strong>Note:</strong> This tool is for general planning only. For actual bookings, use the "Finalization" tab to generate booking-specific ingredients.
            </div>
            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex-grow: 1; min-width: 200px;">
                    <label>Number of Guests</label>
                    <input id="guestCount" type="number" placeholder="e.g. 100" min="1">
                </div>
                <button class="btn btn-primary" style="height: 45px;" onclick="generateIngredientList()">Generate Planning List</button>
            </div>
            <div id="ingredientsPlanning" style="margin-top: 30px;"></div>
        </div>
    </div>

    <div id="finalization" class="tab-content">
        <div class="card">
            <div class="card-header"><h2 class="card-title">Ingredient Finalization</h2></div>
            <div style="display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap;">
                <div class="form-group" style="flex-grow: 1; min-width: 250px;">
                    <label>Select Booking</label>
                    <select id="finalizationOrderSelect" onchange="loadFinalIngredients()"></select>
                </div>
                <button class="btn btn-primary" style="height: 45px;" onclick="generateFinalIngredients()">Generate Final List</button>
            </div>
            <div id="finalizationContent" style="margin-top: 30px;"></div>
        </div>
    </div>

    <div id="availability" class="tab-content">
        <div class="container">
            <h1>ðŸ“… Availability Calendar</h1>
            <p class="subtitle" style="color: var(--text-muted); margin-bottom: 24px; font-size: 15px;">Real-time booking status for next 30 days</p>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Total Dates</div>
                    <div class="stat-value">30</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fully Available</div>
                    <div class="stat-value" style="color: var(--success);" id="availableCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Partially Booked</div>
                    <div class="stat-value" style="color: var(--warning);" id="partialCount">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Fully Booked</div>
                    <div class="stat-value" style="color: var(--danger);" id="fullyBookedCount">-</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background:#ECFDF5;border:2px solid #10B981;"></div>
                    <span>All Slots Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#FEF3C7;border:2px solid #F59E0B;"></div>
                    <span>Partially Booked</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#FEE2E2;border:2px solid #EF4444;"></div>
                    <span>Fully Booked</span>
                </div>
            </div>

            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterCalendar('all',this)">All Dates</button>
                <button class="filter-btn" onclick="filterCalendar('available',this)">Available Only</button>
                <button class="filter-btn" onclick="filterCalendar('partially',this)">Partially Booked</button>
                <button class="filter-btn" onclick="filterCalendar('fully-booked',this)">Fully Booked</button>
            </div>

            <div class="loading" id="loading">Loading calendar data...</div>

            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>
</main>

<script>
    // Mobile Sidebar Toggle
    function toggleMobileSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('mobile-open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const toggle = document.querySelector('.sidebar-toggle');
        
        if (window.innerWidth <= 768 && 
            sidebar.classList.contains('mobile-open') && 
            !sidebar.contains(event.target) && 
            !toggle.contains(event.target)) {
            sidebar.classList.remove('mobile-open');
        }
    });

    // Global state
    let currentIngredients = [];
    let currentBookingId = null;
    let allOrders = [];
    let filteredOrders = [];
    let calendarData = [];
    let currentFilter = 'all';
    let currentPlanningIngredients = {};

    // Ingredient database for planning
    const allIngredients = [
        {name: "Onions", category: "Vegetables", base_qty: 100, unit: "grams"},
        {name: "Tomatoes", category: "Vegetables", base_qty: 50, unit: "grams"},
        {name: "Potatoes", category: "Vegetables", base_qty: 80, unit: "grams"},
        {name: "Mixed Vegetables", category: "Vegetables", base_qty: 100, unit: "grams"},
        {name: "Ginger-Garlic Paste", category: "Vegetables", base_qty: 10, unit: "grams"},
        {name: "Mint & Coriander", category: "Vegetables", base_qty: 10, unit: "grams"},
        {name: "Coriander Leaves", category: "Vegetables", base_qty: 5, unit: "grams"},
        {name: "Curry Leaves", category: "Vegetables", base_qty: 1, unit: "grams"},
        {name: "Tamarind", category: "Vegetables", base_qty: 10, unit: "grams"},
        {name: "Chicken", category: "Non-Vegetarian", base_qty: 250, unit: "grams"},
        {name: "Mutton", category: "Non-Vegetarian", base_qty: 250, unit: "grams"},
        {name: "Spices (Mix)", category: "Spices", base_qty: 5, unit: "grams"},
        {name: "Biryani Spices", category: "Spices", base_qty: 8, unit: "grams"},
        {name: "Curry Spices", category: "Spices", base_qty: 10, unit: "grams"},
        {name: "Cumin Seeds", category: "Spices", base_qty: 2, unit: "grams"},
        {name: "Red Chili Powder", category: "Spices", base_qty: 30, unit: "grams"},
        {name: "Turmeric Powder", category: "Spices", base_qty: 2, unit: "grams"},
        {name: "Mustard Seeds", category: "Spices", base_qty: 2, unit: "grams"},
        {name: "Sambar Powder", category: "Spices", base_qty: 5, unit: "grams"},
        {name: "Basmati Rice", category: "Other", base_qty: 150, unit: "grams"},
        {name: "Toor Dal", category: "Other", base_qty: 80, unit: "grams"},
        {name: "Dosa Batter", category: "Other", base_qty: 100, unit: "ml"},
        {name: "Idli Batter", category: "Other", base_qty: 100, unit: "ml"},
        {name: "Ghee", category: "Other", base_qty: 15, unit: "ml"},
        {name: "Oil", category: "Other", base_qty: 20, unit: "ml"},
        {name: "Butter", category: "Other", base_qty: 20, unit: "g"},
        {name: "Cream", category: "Other", base_qty: 30, unit: "ml"},
        {name: "Yogurt", category: "Other", base_qty: 50, unit: "grams"},
        {name: "Paneer", category: "Other", base_qty: 100, unit: "grams"}
    ];

    // API Call Helper
    async function apiCall(endpoint, method='GET', data=null){
        const config={method, headers:{'Content-Type':'application/json'}};
        if(data) config.body=JSON.stringify(data);
        try {
            const response = await fetch(endpoint, config);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            return response.json();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    function switchTab(id, btn){
        document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(btn) btn.classList.add('active');

        // Close mobile sidebar after tab selection
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('mobile-open');
        }

        if (id === 'orders') {
            loadOrders();
        } else if (id === 'finalization') {
            loadFinalizationOrders();
        } else if (id === 'availability') {
            loadCalendar();
        }
    }

    async function loadStats(){
        try{
            const stats = await apiCall('/admin/api/stats');
            if(!stats.error){
                document.getElementById('statOrders').textContent = stats.total_orders || 0;
                document.getElementById('statDishes').textContent = stats.active_dishes || 0;
                document.getElementById('statRevenue').textContent = 'â‚¹' + (stats.revenue || 0).toLocaleString();
                document.getElementById('statPending').textContent = stats.pending_orders || 0;
            }
        }catch(e){ 
            console.error('Error loading stats:', e); 
        }
    }

    function renderDishes(dishes){
        const grid = document.getElementById('dishesGrid');
        grid.innerHTML = "";
        
        if (!dishes || dishes.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: var(--text-muted); grid-column: 1/-1; padding: 40px;">No dishes found</p>';
            return;
        }
        
        dishes.forEach(d => {
            const dishId = d._id || d.id;
            const available = d.is_active !== false && d.available !== false;
            grid.innerHTML += `
                <div class="dish-card">
                    <img class="dish-img" src="${d.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${d.name}">
                    <div class="dish-info">
                        <div class="dish-cat">${d.category || 'General'}</div>
                        <h3 style="margin-bottom:10px">${d.name}</h3>
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 12px;">
                            <span class="dish-price">â‚¹${d.price}</span>
                            <div style="display:flex; gap:12px; align-items:center">
                                <input type="checkbox" ${available?'checked':''} onchange="updateDishAvailability('${dishId}', this.checked)" style="width: 18px; height: 18px; cursor: pointer;">
                                <i class="fas fa-trash" onclick="deleteDish('${dishId}')" style="color:var(--danger); cursor:pointer; font-size: 16px;"></i>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
    }

    // Ingredient management for dish form
    let dishIngredients = [];

    function addIngredientRow(){
        const container = document.getElementById('ingredientsContainer');
        const rowDiv = document.createElement('div');
        rowDiv.className = 'ingredient-row';

        rowDiv.innerHTML = `
            <input type="text" placeholder="Ingredient name" class="ing-name">
            <input type="number" placeholder="Qty for 10 persons" step="0.01" min="0" class="ing-qty">
            <select class="ing-unit">
                <option value="gm">gm</option>
                <option value="kg">kg</option>
                <option value="litre">litre</option>
                <option value="pcs">pcs</option>
            </select>
            <select class="ing-category">
                <option value="Vegetables">Vegetables</option>
                <option value="Non-Vegetarian">Non-Vegetarian</option>
                <option value="Spices">Spices</option>
                <option value="Others">Others</option>
            </select>
            <button onclick="removeIngredientRow(this)" style="padding: 10px 14px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">Remove</button>
        `;

        container.appendChild(rowDiv);
    }

    function removeIngredientRow(button){
        button.parentElement.remove();
    }

    function clearAllIngredients(){
        if(confirm('Clear all ingredients?')){
            document.getElementById('ingredientsContainer').innerHTML = '';
            dishIngredients = [];
        }
    }

    function collectDishIngredients(){
        const rows = document.querySelectorAll('.ingredient-row');
        const ingredients = [];

        rows.forEach(row => {
            const name = row.querySelector('.ing-name').value.trim();
            const qty = parseFloat(row.querySelector('.ing-qty').value);
            const unit = row.querySelector('.ing-unit').value;
            const category = row.querySelector('.ing-category').value;

            if(name && qty > 0){
                ingredients.push({
                    name: name,
                    per_plate: qty,
                    unit: unit,
                    category: category
                });
            }
        });

        return ingredients;
    }

    async function addDish(){
        const name = document.getElementById('dishName').value.trim();
        const category = document.getElementById('dishCategory').value;
        const price = parseFloat(document.getElementById('dishPrice').value);
        const imageUrl = document.getElementById('dishImageUrl').value.trim();
        const description = document.getElementById('dishDescription').value.trim();
        const available = document.getElementById('dishAvailable').checked;
        const ingredients = collectDishIngredients();

        if(!name || !price || price <= 0){
            alert('Please enter valid dish name and price');
            return;
        }

        try{
            const response = await apiCall('/admin/api/dishes', 'POST', {
                name, category, price, image_url: imageUrl, description, available, ingredients
            });

            if(response.message || response.success){
                alert('Dish added successfully!');
                document.getElementById('dishName').value = '';
                document.getElementById('dishPrice').value = '';
                document.getElementById('dishImageUrl').value = '';
                document.getElementById('dishDescription').value = '';
                document.getElementById('dishAvailable').checked = true;
                clearAllIngredients();
                loadDishes();
                loadStats();
            }
        }catch(e){
            alert('Error adding dish: ' + e.message);
        }
    }

    async function deleteDish(dishId){
        if(!confirm('Are you sure you want to delete this dish?')) return;

        try{
            const response = await apiCall(`/admin/api/dishes/${dishId}`, 'DELETE');
            if(response.message || response.success){
                alert('Dish deleted successfully!');
                loadDishes();
                loadStats();
            }
        }catch(e){
            alert('Error deleting dish: ' + e.message);
        }
    }

    async function updateDishAvailability(dishId, available){
        try{
            await apiCall(`/admin/api/dishes/${dishId}`, 'PUT', { available });
            loadStats();
        }catch(e){
            console.error('Error updating dish availability:', e);
            alert('Error updating dish availability');
        }
    }

    async function loadDishes(){
        try{
            const dishes = await apiCall('/admin/api/dishes');
            if(Array.isArray(dishes)){
                renderDishes(dishes);
                const categories = [...new Set(dishes.map(d => d.category).filter(Boolean))];
                const filterSelect = document.getElementById('filterCategory');
                filterSelect.innerHTML = '<option value="">All</option>';
                categories.forEach(cat => {
                    filterSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
            }
        }catch(e){
            console.error('Error loading dishes:', e);
        }
    }

    function filterDishes(){
        const search = document.getElementById('filterSearch').value.toLowerCase();
        const category = document.getElementById('filterCategory').value;
        const cards = document.querySelectorAll('.dish-card');

        cards.forEach(card => {
            const name = card.querySelector('h3').textContent.toLowerCase();
            const cat = card.querySelector('.dish-cat').textContent;
            const matchesSearch = name.includes(search);
            const matchesCategory = !category || cat === category;
            card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
        });
    }

    async function loadOrders(){
        const loading = document.getElementById('ordersLoading');
        const errorDiv = document.getElementById('ordersError');

        loading.style.display = 'block';
        errorDiv.style.display = 'none';

        try{
            const response = await apiCall('/admin/api/bookings');
            loading.style.display = 'none';

            if(response.success && Array.isArray(response.bookings)){
                allOrders = response.bookings;
                filteredOrders = [...allOrders];
                renderOrdersTable(filteredOrders);
            } else {
                throw new Error('Invalid response format');
            }
        }catch(e){
            loading.style.display = 'none';
            errorDiv.textContent = 'Error loading orders: ' + e.message;
            errorDiv.style.display = 'block';
            console.error('Error loading orders:', e);
        }
    }

    function renderOrdersTable(orders){
        const tableBody = document.getElementById('ordersTableBody');

        if(!tableBody) return;

        tableBody.innerHTML = '';

        if(orders.length === 0){
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="7" class="empty-state">No orders found</td>';
            tableBody.appendChild(emptyRow);
            return;
        }

        orders.forEach(order => {
            const orderId = order._id || order.id;
            const statusClass = `status-${order.status.toLowerCase()}`;

            let actionButtons = `
                <button class="action-btn action-view" onclick="viewOrderDetails('${orderId}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
            `;

            if (order.status === 'Pending') {
                actionButtons += `
                    <button class="action-btn action-ingredients" onclick="manageIngredients('${orderId}')" title="Manage Ingredients">
                        <i class="fas fa-list-check"></i>
                    </button>
                `;
            } else if (order.status === 'APPROVED') {
                actionButtons += `
                    <button class="action-btn action-pdf" onclick="downloadOrderPDF('${orderId}')" title="Download PDF">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn action-ingredients" onclick="manageIngredients('${orderId}')" title="Edit Ingredients">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="action-btn" style="background: var(--success); color: white;" onclick="markOrderCompleted('${orderId}')" title="Mark Completed">
                        <i class="fas fa-check"></i>
                    </button>
                `;
            } else if (order.status === 'Completed') {
                actionButtons += `
                    <button class="action-btn action-pdf" onclick="downloadOrderPDF('${orderId}')" title="Download PDF">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="action-btn" style="background: var(--danger); color: white;" onclick="deleteOrder('${orderId}', this)" title="Delete Order">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            } else if (order.status === 'Cancelled') {
                actionButtons += `
                    <button class="action-btn" style="background: var(--danger); color: white;" onclick="deleteOrder('${orderId}', this)" title="Delete Order">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="order-id">${orderId.substring(0, 8)}...</td>
                <td>${order.customer_name}</td>
                <td>${order.event_date}</td>
                <td>${order.guests}</td>
                <td class="order-amount">â‚¹${order.pricing?.total || 0}</td>
                <td><span class="status-badge ${statusClass}">${order.status}</span></td>
                <td style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${actionButtons}
                </td>
            `;

            tableBody.appendChild(row);
        });
    }

    function applyFilters(){
        const fromDate = document.getElementById('filterFromDate').value;
        const toDate = document.getElementById('filterToDate').value;
        const timeSlot = document.getElementById('filterTimeSlot').value;
        const status = document.getElementById('filterStatus').value;

        filteredOrders = allOrders.filter(order => {
            if(fromDate && order.event_date < fromDate) return false;
            if(toDate && order.event_date > toDate) return false;
            if(timeSlot && order.time_slot !== timeSlot) return false;
            if(status && order.status !== status) return false;
            return true;
        });

        renderOrdersTable(filteredOrders);
    }

    function clearFilters(){
        document.getElementById('filterFromDate').value = '';
        document.getElementById('filterToDate').value = '';
        document.getElementById('filterTimeSlot').value = '';
        document.getElementById('filterStatus').value = '';
        filteredOrders = [...allOrders];
        renderOrdersTable(filteredOrders);
    }

    async function viewOrderDetails(orderId){
        try{
            const response = await apiCall(`/admin/api/bookings/${orderId}`);
            if(response.success){
                const order = response.booking;
                const details = `Order ID: ${orderId}
Customer: ${order.customer_name}
Phone: ${order.mobile}
Email: ${order.email}
Event Date: ${order.event_date}
Time Slot: ${order.time_slot}
Guests: ${order.guests}
Location: ${order.event_location}
Service Type: ${order.service_type}
Food Preference: ${order.food_preference}
Status: ${order.status}
Total Amount: â‚¹${order.pricing?.total || 0}

Dishes:
${order.dishes?.map(d => `- ${d.dish_name} (${d.quantity})`).join('\n') || 'No dishes'}

Pricing Breakdown:
Subtotal: â‚¹${order.pricing?.subtotal || 0}
Service Charge (10%): â‚¹${order.pricing?.service_charge || 0}
GST (5%): â‚¹${order.pricing?.gst || 0}
Total: â‚¹${order.pricing?.total || 0}`;
                alert(details);
            }
        }catch(e){
            alert('Error loading order details: ' + e.message);
        }
    }

    async function manageIngredients(orderId){
        switchTab('finalization');
        await loadFinalizationOrders();
        document.getElementById('finalizationOrderSelect').value = orderId;
        loadFinalIngredients();
    }

    async function downloadOrderPDF(orderId){
        window.open(`/admin/api/ingredients/booking/${orderId}/pdf`, '_blank');
    }

    async function markOrderCompleted(orderId){
        if(!confirm('Are you sure you want to mark this order as completed?')){
            return;
        }

        try{
            const response = await apiCall(`/admin/api/bookings/${orderId}/status`, 'PATCH', { status: 'Completed' });
            if(response.success){
                alert('âœ… Order marked as completed successfully');
                loadOrders();
                loadStats();
            }
        }catch(e){
            alert('âŒ Error updating order status: ' + e.message);
        }
    }

    async function deleteOrder(orderId, buttonElement){
        if(!confirm('âš ï¸ Are you sure you want to PERMANENTLY delete this order?\n\nThis action cannot be undone.')){
            return;
        }

        try{
            const response = await apiCall(`/admin/api/bookings/${orderId}`, 'DELETE');

            if(response.success){
                alert('âœ… Order deleted successfully');

                if(buttonElement){
                    const row = buttonElement.closest('tr');
                    if(row){
                        row.remove();
                    }
                }

                loadStats();
            }
        }catch(e){
            alert('âŒ Error deleting order: ' + e.message);
        }
    }

    function logout(){
        if(confirm('Are you sure you want to logout?')){
            window.location.href = '/admin/logout';
        }
    }

    // Ingredient Planning
    function generateIngredientList(){
        const guests = parseInt(document.getElementById('guestCount').value);
        if(!guests || guests < 1){
            alert('Please enter a valid number of guests');
            return;
        }

        currentPlanningIngredients = {};
        allIngredients.forEach(ing => {
            const calculatedQty = ing.base_qty * guests;
            const item = {
                name: ing.name,
                quantity: calculatedQty,
                unit: ing.unit,
                checked: true
            };
            if(!currentPlanningIngredients[ing.category]){
                currentPlanningIngredients[ing.category] = [];
            }
            currentPlanningIngredients[ing.category].push(item);
        });

        renderIngredientsPlanning();
    }

    function getCategoryIcon(cat){
        if(cat === 'Vegetables') return 'ðŸ¥¬';
        if(cat === 'Non-Vegetarian') return 'ðŸ—';
        if(cat === 'Spices') return 'ðŸŒ¶ï¸';
        return 'ðŸ§‚';
    }

    function renderIngredientsPlanning(){
        const container = document.getElementById('ingredientsPlanning');
        let html = '';

        for(const [cat, ingredients] of Object.entries(currentPlanningIngredients)){
            html += `<h3 style="margin: 24px 0 12px; color: var(--primary);">${getCategoryIcon(cat)} ${cat}</h3>
                     <div class="ingredient-list" style="margin-bottom: 24px; border: 1px solid var(--border); border-radius: 10px; padding: 16px; background: white;">`;
            ingredients.forEach((ing, index) => {
                const checked = ing.checked !== false ? 'checked' : '';
                html += `
                    <div class="ingredient-row">
                        <input type="checkbox" ${checked} onchange="updatePlanningIngredientCheck('${cat}', ${index}, this.checked)" style="width: 18px; height: 18px;">
                        <input type="text" value="${ing.name}" onchange="updatePlanningIngredientName('${cat}', ${index}, this.value)">
                        <input type="number" value="${ing.quantity}" step="0.01" onchange="updatePlanningIngredientQuantity('${cat}', ${index}, this.value)">
                        <input type="text" value="${ing.unit}" onchange="updatePlanningIngredientUnit('${cat}', ${index}, this.value)" style="width: 80px;">
                        <button onclick="removePlanningIngredient('${cat}', ${index})" style="padding: 10px 14px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">Remove</button>
                    </div>
                `;
            });
            html += '</div>';
        }

        html += '<button class="btn btn-primary" onclick="addNewPlanningIngredient()"><i class="fas fa-plus"></i> Add New Ingredient</button>';
        container.innerHTML = html;
    }

    function updatePlanningIngredientCheck(cat, index, checked){
        if(currentPlanningIngredients[cat] && currentPlanningIngredients[cat][index]){
            currentPlanningIngredients[cat][index].checked = checked;
        }
    }

    function updatePlanningIngredientName(cat, index, name){
        if(currentPlanningIngredients[cat] && currentPlanningIngredients[cat][index]){
            currentPlanningIngredients[cat][index].name = name;
        }
    }

    function updatePlanningIngredientQuantity(cat, index, quantity){
        if(currentPlanningIngredients[cat] && currentPlanningIngredients[cat][index]){
            currentPlanningIngredients[cat][index].quantity = parseFloat(quantity) || 0;
        }
    }

    function updatePlanningIngredientUnit(cat, index, unit){
        if(currentPlanningIngredients[cat] && currentPlanningIngredients[cat][index]){
            currentPlanningIngredients[cat][index].unit = unit;
        }
    }

    function removePlanningIngredient(cat, index){
        if(confirm('Remove this ingredient?') && currentPlanningIngredients[cat]){
            currentPlanningIngredients[cat].splice(index, 1);
            renderIngredientsPlanning();
        }
    }

    function addNewPlanningIngredient(){
        const name = prompt('Ingredient name:');
        if(!name) return;
        const category = prompt('Category (Vegetables, Non-Vegetarian, Spices, Other):') || 'Other';
        const qty = parseFloat(prompt('Quantity:')) || 0;
        const unit = prompt('Unit:') || 'g';

        if(!currentPlanningIngredients[category]){
            currentPlanningIngredients[category] = [];
        }
        currentPlanningIngredients[category].push({
            name, quantity: qty, unit, checked: true
        });
        renderIngredientsPlanning();
    }

    // Finalization functions
    async function loadFinalizationOrders(){
        try{
            const pendingResponse = await apiCall('/admin/api/bookings?status=Pending');
            const confirmedResponse = await apiCall('/admin/api/bookings?status=Confirmed');
            const approvedResponse = await apiCall('/admin/api/bookings?status=APPROVED');

            if(pendingResponse.success && confirmedResponse.success && approvedResponse.success){
                const orders = [...pendingResponse.bookings, ...confirmedResponse.bookings, ...approvedResponse.bookings];

                orders.sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

                const select = document.getElementById('finalizationOrderSelect');
                select.innerHTML = '<option value="">-- Select Order for Finalization --</option>';

                orders.forEach(order => {
                    const orderId = order._id || order.id;
                    const statusBadge = order.status === 'Pending' ? 'ðŸŸ¡' : order.status === 'APPROVED' ? 'ðŸŸ¢' : 'ðŸ”µ';
                    select.innerHTML += `
                        <option value="${orderId}">
                            ${statusBadge} ${orderId.substring(0,8)} - ${order.customer_name}
                            (${order.event_date}) - ${order.status}
                        </option>`;
                });
            }
        }catch(e){
            console.error('Error loading finalization orders:', e);
            alert('Error loading orders: ' + e.message);
        }
    }

    async function loadFinalIngredients(){
        const bookingId = document.getElementById('finalizationOrderSelect').value;
        if(!bookingId){
            document.getElementById('finalizationContent').innerHTML = '';
            return;
        }

        currentBookingId = bookingId;

        try{
            const data = await apiCall(`/admin/api/ingredients/booking/${bookingId}`);
            if(data.success){
                currentIngredients = data.ingredients || [];
                renderFinalIngredients(bookingId, data);
            } else {
                document.getElementById('finalizationContent').innerHTML = '<p class="empty-state">No final ingredients found for this booking. Click "Generate Final List" to create.</p>';
            }
        }catch(e){
            console.error('Error loading final ingredients:', e);
            document.getElementById('finalizationContent').innerHTML = '<p class="empty-state">No final ingredients found for this booking. Click "Generate Final List" to create.</p>';
        }
    }

    async function generateFinalIngredients(){
        const bookingId = document.getElementById('finalizationOrderSelect').value;
        if(!bookingId){
            alert('Please select a booking');
            return;
        }

        try{
            const response = await apiCall(`/admin/api/ingredients/booking/${bookingId}/generate`, 'POST');
            if(response.success){
                alert('Final ingredients generated successfully!');
                loadFinalIngredients();
            }
        }catch(e){
            if(e.message.includes('already exist')){
                alert('Final ingredients already exist for this booking. Edit them below.');
                loadFinalIngredients();
            } else {
                alert('Error: ' + e.message);
            }
        }
    }

    function renderFinalIngredients(bookingId, data){
        const container = document.getElementById('finalizationContent');
        const ingredients = data.ingredients || [];
        const approved = data.approved_by_admin;

        const categorizedIngredients = {
            'Vegetables': [],
            'Non-Vegetarian': [],
            'Spices / Masala': [],
            'Other': []
        };

        ingredients.forEach((ing, index) => {
            let category = 'Other';
            const name = ing.name.toLowerCase();
            if (['onion', 'tomato', 'potato', 'vegetable', 'ginger', 'garlic', 'mint', 'coriander', 'curry leaves', 'tamarind', 'mixed vegetables'].some(v => name.includes(v))) {
                category = 'Vegetables';
            } else if (['chicken', 'mutton', 'fish', 'meat', 'egg'].some(nv => name.includes(nv))) {
                category = 'Non-Vegetarian';
            } else if (['spices', 'masala', 'cumin', 'red chili', 'turmeric', 'mustard', 'sambar', 'biryani'].some(s => name.includes(s))) {
                category = 'Spices / Masala';
            }
            categorizedIngredients[category].push({...ing, originalIndex: index});
        });

        let html = `
            <div style="background: var(--bg-body); padding: 24px; border-radius: 10px; margin-bottom: 24px;">
                <h3 style="margin-bottom: 12px;">Booking: ${bookingId}</h3>
                <p style="margin-bottom: 8px;"><strong>Status:</strong> <span style="color: ${approved ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">${approved ? 'Approved' : 'Pending Approval'}</span></p>
                <p><strong>Ingredients Count:</strong> ${ingredients.length}</p>
            </div>

            <div style="margin-bottom: 24px;">
                <h4 style="margin-bottom: 16px;">Step 1: Preview & Finalize Ingredients</h4>
                <div id="ingredientsList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 10px; padding: 16px; background: white;">
        `;

        if(ingredients.length === 0){
            html += '<p class="empty-state">No ingredients found. Click "Generate Final List" to create.</p>';
        } else {
            for (const [category, catIngredients] of Object.entries(categorizedIngredients)) {
                if (catIngredients.length === 0) continue;

                const categoryIcon = getCategoryIcon(category);
                html += `<h5 style="margin: 20px 0 12px 0; color: var(--primary); border-bottom: 2px solid var(--border); padding-bottom: 8px; font-size: 16px;">${categoryIcon} ${category}</h5>`;

                catIngredients.forEach((ing) => {
                    const checked = ing.checked !== false ? 'checked' : '';
                    html += `
                        <div class="ingredient-row">
                            <input type="checkbox" ${checked} onchange="updateIngredientCheck(${ing.originalIndex}, this.checked)" style="width: 18px; height: 18px;">
                            <input type="text" value="${ing.name}" onchange="updateIngredientName(${ing.originalIndex}, this.value)">
                            <input type="number" value="${ing.quantity}" step="0.01" onchange="updateIngredientQuantity(${ing.originalIndex}, this.value)" style="width: 120px;">
                            <select onchange="updateIngredientUnit(${ing.originalIndex}, this.value)" style="width: 100px;">
                                <option value="g" ${ing.unit === 'g' ? 'selected' : ''}>g</option>
                                <option value="kg" ${ing.unit === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                                <option value="l" ${ing.unit === 'l' ? 'selected' : ''}>litre</option>
                                <option value="pcs" ${ing.unit === 'pcs' ? 'selected' : ''}>pcs</option>
                            </select>
                            <button onclick="removeIngredient(${ing.originalIndex})" style="padding: 10px 14px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">Remove</button>
                        </div>
                    `;
                });
            }
        }

        html += `
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="addNewIngredient()"><i class="fas fa-plus"></i> Add Ingredient</button>
                <button class="btn btn-primary" onclick="saveFinalIngredients()"><i class="fas fa-save"></i> Save Changes</button>
                <button class="btn btn-warning" onclick="editIngredientsAgain()"><i class="fas fa-edit"></i> Edit Again</button>
                ${!approved ? `<button class="btn btn-success" onclick="confirmAndSubmit()"><i class="fas fa-check-circle"></i> Confirm & Submit</button>` : ''}
                ${approved ? `<button class="btn btn-primary" onclick="downloadFinalPDF()"><i class="fas fa-download"></i> Download PDF</button>` : ''}
                ${approved ? `<button class="btn btn-info" onclick="sharePDF()"><i class="fas fa-share"></i> Share PDF</button>` : ''}
            </div>
        `;

        container.innerHTML = html;
    }

    function updateIngredientCheck(index, checked){
        if(currentIngredients[index]) {
            currentIngredients[index].checked = checked;
        }
    }

    function updateIngredientName(index, name){
        if(currentIngredients[index]) {
            currentIngredients[index].name = name;
        }
    }

    function updateIngredientQuantity(index, quantity){
        if(currentIngredients[index]) {
            currentIngredients[index].quantity = parseFloat(quantity) || 0;
        }
    }

    function updateIngredientUnit(index, unit){
        if(currentIngredients[index]) {
            currentIngredients[index].unit = unit;
        }
    }

    function removeIngredient(index){
        if(confirm('Remove this ingredient?')){
            currentIngredients.splice(index, 1);
            renderIngredientsList();
        }
    }

    function addNewIngredient(){
        currentIngredients.push({
            name: 'New Ingredient',
            quantity: 0,
            unit: 'g',
            checked: true
        });
        renderIngredientsList();
    }

    function renderIngredientsList(){
        const listContainer = document.getElementById('ingredientsList');
        if(!listContainer) return;

        let html = '';

        if(currentIngredients.length === 0){
            html = '<p class="empty-state">No ingredients found</p>';
        } else {
            currentIngredients.forEach((ing, index) => {
                const checked = ing.checked !== false ? 'checked' : '';
                html += `
                    <div class="ingredient-row">
                        <input type="checkbox" ${checked} onchange="updateIngredientCheck(${index}, this.checked)" style="width: 18px; height: 18px;">
                        <input type="text" value="${ing.name}" onchange="updateIngredientName(${index}, this.value)">
                        <input type="number" value="${ing.quantity}" step="0.01" onchange="updateIngredientQuantity(${index}, this.value)" style="width: 120px;">
                        <input type="text" value="${ing.unit}" onchange="updateIngredientUnit(${index}, this.value)" style="width: 80px;">
                        <button onclick="removeIngredient(${index})" style="padding: 10px 14px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer;">Remove</button>
                    </div>
                `;
            });
        }

        listContainer.innerHTML = html;
    }

    async function saveFinalIngredients(){
        if(!currentBookingId){
            alert('Please select a booking');
            return;
        }

        try{
            const response = await apiCall(`/admin/api/ingredients/booking/${currentBookingId}`, 'PUT', {
                ingredients: currentIngredients
            });
            if(response.success){
                alert('Final ingredients saved successfully!');
                loadFinalIngredients();
            }
        }catch(e){
            alert('Error: ' + e.message);
        }
    }

    async function editIngredientsAgain(){
        if(!currentBookingId){
            alert('Please select a booking first');
            return;
        }

        try{
            const data = await apiCall(`/admin/api/ingredients/booking/${currentBookingId}`);
            if(data.success){
                currentIngredients = data.ingredients || [];
                renderFinalIngredients(currentBookingId, data);
                alert('Ingredients reloaded for editing. Make your changes and click "Save Changes" when done.');
            } else {
                alert('No saved ingredients found for this booking.');
            }
        }catch(e){
            console.error('Error reloading ingredients:', e);
            alert('Error reloading ingredients: ' + e.message);
        }
    }

    async function confirmAndSubmit(){
        if(!currentBookingId){
            alert('Please select a booking');
            return;
        }

        if(!confirm('Are you sure you want to confirm and submit these final ingredients? This will approve them and update the order status to "APPROVED".')){
            return;
        }

        try{
            const response = await apiCall(`/admin/api/ingredients/booking/${currentBookingId}/approve`, 'POST');
            if(response.success){
                alert('Final ingredients confirmed and submitted successfully! Order status updated to "APPROVED".');
                loadFinalIngredients();
                loadOrders();
            }
        }catch(e){
            alert('Error: ' + e.message);
        }
    }

    async function downloadFinalPDF(){
        if(!currentBookingId){
            alert('Please select a booking');
            return;
        }

        window.open(`/admin/api/ingredients/booking/${currentBookingId}/pdf`, '_blank');
    }

    async function sharePDF(){
        if(!currentBookingId){
            alert('Please select a booking');
            return;
        }

        const shareOptions = confirm(
            'Share PDF via:\n\n' +
            'OK = Email & WhatsApp\n' +
            'Cancel = Choose method'
        );

        if(shareOptions){
            await sharePDFMethod('both');
        } else {
            const method = prompt('Enter: "email" or "whatsapp"');
            if(method === 'email' || method === 'whatsapp'){
                await sharePDFMethod(method);
            } else {
                alert('Invalid method');
            }
        }
    }

    async function sharePDFMethod(method){
        try{
            const response = await apiCall(
                `/admin/api/ingredients/booking/${currentBookingId}/share`,
                'POST',
                { method }
            );

            if(response.success){
                let message = 'PDF shared successfully!\n\n';

                if(response.email_sent){
                    message += 'âœ… Email sent to customer\n';
                }

                if(response.whatsapp_link){
                    message += 'âœ… WhatsApp link generated\n';
                    message += `\nClick to send via WhatsApp:\n${response.whatsapp_link}`;

                    if(confirm('Open WhatsApp to send message?')){
                        window.open(response.whatsapp_link, '_blank');
                    }
                }

                alert(message);
            }
        }catch(e){
            alert('Error sharing PDF: ' + e.message);
        }
    }

    // Availability Calendar
    async function loadCalendar() {
        try {
            const response = await fetch('/api/bookings/availability-calendar');
            const data = await response.json();

            if (data.success) {
                calendarData = data.calendar;
                renderCalendar();
                updateStats();
            } else {
                document.getElementById('loading').textContent = 'Failed to load calendar data';
            }
        } catch (error) {
            console.error('Error loading calendar:', error);
            document.getElementById('loading').textContent = 'Error loading data. Please refresh.';
        }
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const loading = document.getElementById('loading');

        loading.style.display = 'none';
        grid.innerHTML = '';

        const filteredData = calendarData.filter(day => {
            if (currentFilter === 'all') return true;
            return day.status === currentFilter.replace('-', '_');
        });

        if (filteredData.length === 0) {
            grid.innerHTML = '<div style="grid-column:1/-1;" class="empty-state">No dates match the selected filter.</div>';
            return;
        }

        filteredData.forEach(day => {
            const date = new Date(day.date);
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            let statusClass = '';
            if (day.status === 'fully_booked') statusClass = 'fully-booked';
            else if (day.status === 'partially_available') statusClass = 'partially';
            else if (day.status === 'available') statusClass = 'available';

            const card = document.createElement('div');
            card.className = `date-card ${statusClass}`;

            let slotsHTML = '';
            const allSlots = ['Morning', 'Afternoon', 'Night'];

            allSlots.forEach(slot => {
                const isAvailable = day.available_slots.includes(slot);
                const slotClass = isAvailable ? 'available' : 'booked';
                const slotText = isAvailable ? `âœ“ ${slot}` : `âœ— ${slot}`;
                slotsHTML += `<div class="slot ${slotClass}">${slotText}</div>`;
            });

            card.innerHTML = `
                <div class="date-header">${dateStr}</div>
                <div class="date-day">${dayName}</div>
                <div class="slots">
                    ${slotsHTML}
                </div>
            `;

            grid.appendChild(card);
        });
    }

    function updateStats() {
        const availableCount = calendarData.filter(d => d.status === 'available').length;
        const partialCount = calendarData.filter(d => d.status === 'partially_available').length;
        const fullyBookedCount = calendarData.filter(d => d.status === 'fully_booked').length;

        document.getElementById('availableCount').textContent = availableCount;
        document.getElementById('partialCount').textContent = partialCount;
        document.getElementById('fullyBookedCount').textContent = fullyBookedCount;
    }

    function filterCalendar(filter, btn) {
        currentFilter = filter;

        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        renderCalendar();
    }

    async function loadCategories() {
        const res = await fetch('/api/dishes/categories');
        const categories = await res.json();

        const select = document.getElementById('dishCategory');
        const filter = document.getElementById('filterCategory');

        select.innerHTML = '';
        filter.innerHTML = '<option value="">All</option>';

        categories.forEach(cat => {
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
            filter.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    }

    async function addCategory() {
        const name = document.getElementById('newCategory').value;
        if (!name) return alert("Enter category");

        await fetch('/api/dishes/categories', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name})
        });

        document.getElementById('newCategory').value = '';
        loadCategories();
    }

    // Auto-refresh calendar every 30 seconds
    setInterval(loadCalendar, 30000);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadStats();
        loadDishes();
        loadOrders();
        loadCategories();
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            document.getElementById('sidebar').classList.remove('mobile-open');
        }
    });
</script>

</body>
</html>
    